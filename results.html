<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚æ´²é›†åœ˜è¯è‹“BPMçµ±è¨ˆåˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0066B3;
            --primary-dark: #003D6B;
            --primary-light: #3399CC;
            --accent-gold: #C9A961;
            --accent-orange: #E67E22;
            --bg-gradient-start: #F0F4F8;
            --bg-gradient-end: #E8EDF2;
            --card-bg: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #5A6C7D;
            --border-color: #E0E7EE;
            --shadow-sm: 0 2px 8px rgba(0, 102, 179, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 102, 179, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 102, 179, 0.16);
            --shadow-xl: 0 12px 48px rgba(0, 102, 179, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Poppins', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(0, 102, 179, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(201, 169, 97, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            width: 95%;
            max-width: 95vw;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            padding: 40px 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .header h1 {
            color: #FFFFFF;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1em;
            font-weight: 300;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header .subtitle::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            background: var(--accent-gold);
            border-radius: 2px;
        }

        .tab-nav {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(to bottom, #FFFFFF 0%, #F8FAFB 100%);
        }

        .tab-button {
            flex: 1;
            padding: 18px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-light));
            border-radius: 2px 2px 0 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }

        .tab-button:hover {
            color: var(--primary-blue);
            background: linear-gradient(to bottom, rgba(0, 102, 179, 0.03) 0%, rgba(0, 102, 179, 0.01) 100%);
        }

        .tab-button.active {
            color: var(--primary-blue);
            background: linear-gradient(to bottom, rgba(0, 102, 179, 0.05) 0%, rgba(0, 102, 179, 0.02) 100%);
        }

        .tab-button.active::before {
            width: 100%;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 32px 28px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-light));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.88em;
            margin-bottom: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .stat-card .value {
            color: var(--text-primary);
            font-size: 2.8em;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-card .unit {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 400;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            box-shadow: var(--shadow-lg), 0 0 40px rgba(0, 102, 179, 0.15);
            border: none;
        }

        .stat-card.highlight::before {
            background: linear-gradient(90deg, var(--accent-gold), #FFD700);
        }

        .stat-card.highlight .label,
        .stat-card.highlight .value,
        .stat-card.highlight .unit {
            color: #FFFFFF;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            transition: box-shadow 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-container h2 {
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, var(--primary-blue), transparent) 1;
            font-weight: 700;
            font-size: 1.4em;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .chart-wrapper.small {
            height: 300px;
        }

        .chart-wrapper.large {
            height: 500px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .table-container.no-scroll {
            overflow-x: hidden;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card-bg);
        }

        table th {
            background: linear-gradient(to bottom, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table th:first-child {
            border-radius: 12px 0 0 0;
        }

        table th:last-child {
            border-radius: 0 12px 0 0;
        }

        table td {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }

        table tr:hover td {
            background: linear-gradient(to right, rgba(0, 102, 179, 0.02) 0%, transparent 100%);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        #rejectDetailTable,
        #mgrRejectDetailTable {
            table-layout: fixed;
            width: 100%;
            min-width: 0;
        }

        #rejectDetailTable th,
        #rejectDetailTable td,
        #mgrRejectDetailTable th,
        #mgrRejectDetailTable td {
            white-space: normal;
            word-break: break-word;
            padding: 6px 4px;
            font-size: 0.78em;
            line-height: 1.3;
            vertical-align: top;
        }

        #rejectDetailTable th,
        #mgrRejectDetailTable th {
            font-size: 0.75em;
            letter-spacing: 0.2px;
        }

        .month-header {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
            gap: 2px;
        }

        .month-header .year {
            font-size: 0.78em;
            opacity: 0.95;
        }

        .month-header .month {
            font-size: 0.9em;
            font-weight: 700;
        }

        #rejectDetailTable .badge,
        #mgrRejectDetailTable .badge {
            padding: 4px 8px;
            font-size: 0.75em;
        }

        .cell-clamp-2 {
            display: block;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
            line-height: 1.4;
            max-height: calc(1.4em * 2);
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .insight-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF4D6 100%);
            border-left: 5px solid var(--accent-gold);
            padding: 24px 28px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .insight-box h3 {
            color: #8B6914;
            margin-bottom: 14px;
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-box h3::before {
            content: 'ğŸ’¡';
            font-size: 1.2em;
        }

        .insight-box ul {
            margin-left: 20px;
            color: #6B5610;
        }

        .insight-box li {
            margin: 10px 0;
            line-height: 1.7;
        }

        .insight-box strong {
            color: #8B6914;
            font-weight: 700;
        }

        .footer {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 40px;
            padding: 30px 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        @media (max-width: 1024px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 30px 25px;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .stat-card .value {
                font-size: 2.2em;
            }

            .tab-button {
                font-size: 0.75em;
                padding: 14px 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                padding: 20px;
            }

            .chart-wrapper {
                height: 300px;
            }

            .chart-wrapper.large {
                height: 350px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h1 style="margin: 0;">ğŸ“Š ç‚æ´²é›†åœ˜è¯è‹“BPMçµ±è¨ˆåˆ†æå ±è¡¨</h1>
                <button onclick="window.location.href='index.html'"
                    style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s;">
                    â† è¿”å›ä¸Šå‚³
                </button>
            </div>
            <div class="subtitle">æª”æ¡ˆ: <span id="uploadedFileName">-</span></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('monthly')">ğŸ“… æœˆåº¦çµ±è¨ˆåˆ†æ</button>
                <button class="tab-button" onclick="switchTab('company')">ğŸ¢ å…¬å¸åˆ¥çµ±è¨ˆåˆ†æ</button>
                <button class="tab-button" onclick="switchTab('signature')">âœï¸ ç°½æ ¸æ¬¡æ•¸çµ±è¨ˆ</button>
                <button class="tab-button" onclick="switchTab('reject')">âŒ ç”³è«‹äººè¢«é§å›çµ±è¨ˆ</button>
                <button class="tab-button" onclick="switchTab('manager-reject')">âš ï¸ ä¸»ç®¡é§å›æ¬¡æ•¸çµ±è¨ˆ</button>
                <button class="tab-button" onclick="switchTab('approval-time')">â±ï¸ ç°½æ ¸æ™‚é–“çµ±è¨ˆ</button>
            </div>
        </div>

        <!-- Monthly Tab Content -->
        <div id="monthly-tab" class="tab-content active">
            <!-- é—œéµæŒ‡æ¨™ -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">ä¸Šæœˆç¸½æµé‡ (2025å¹´11æœˆ)</div>
                    <div class="value" id="lastMonthTotal">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">13å€‹æœˆç¸½æµé‡</div>
                    <div class="value" id="totalForms">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">è¡¨å–®ç¨®é¡</div>
                    <div class="value" id="formTypes">-</div>
                    <div class="unit">ç¨®</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœˆå¹³å‡æµé‡</div>
                    <div class="value" id="avgMonthly">-</div>
                    <div class="unit">ç­†</div>
                </div>
            </div>

            <!-- é—œéµç™¼ç¾ -->
            <div class="chart-container">
                <h2>ğŸ” é—œéµç™¼ç¾èˆ‡æ´å¯Ÿ</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="insights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <!-- æœˆåº¦è¶¨å‹¢ -->
            <div class="chart-container">
                <h2>ğŸ“ˆ æœˆåº¦æµé‡è¶¨å‹¢</h2>
                <div class="chart-wrapper large">
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
            </div>

            <!-- é¡åˆ¥åˆ†å¸ƒ -->
            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ“Š è¡¨å–®é¡åˆ¥åˆ†å¸ƒ</h2>
                    <div class="chart-wrapper">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ† å„é¡åˆ¥æµé‡çµ±è¨ˆ</h2>
                    <div class="chart-wrapper">
                        <canvas id="categoryBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ç†±é–€è¡¨å–® -->
            <div class="chart-container">
                <h2>ğŸ”¥ ç†±é–€è¡¨å–® TOP 10</h2>
                <div class="chart-wrapper large">
                    <canvas id="topFormsChart"></canvas>
                </div>
            </div>

            <!-- é¡åˆ¥æœˆåº¦è¶¨å‹¢ -->
            <div class="chart-container">
                <h2>ğŸ“‰ å„é¡åˆ¥æœˆåº¦è¶¨å‹¢</h2>
                <div class="chart-wrapper large">
                    <canvas id="categoryTrendChart"></canvas>
                </div>
            </div>

            <!-- è©³ç´°è¡¨å–®çµ±è¨ˆ -->
            <div class="chart-container">
                <h2>ğŸ“‹ è©³ç´°è¡¨å–®çµ±è¨ˆ</h2>
                <div class="table-container">
                    <table id="detailTable">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>é¡åˆ¥</th>
                                <th>è¡¨å–®åç¨±</th>
                                <th>ç¸½è¨ˆ</th>
                                <th>æœˆå¹³å‡</th>
                                <th>ä¸Šæœˆæµé‡</th>
                                <th>è¶¨å‹¢</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody">
                            <tr>
                                <td colspan="7">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Company Tab Content -->
        <div id="company-tab" class="tab-content">
            <!-- é—œéµæŒ‡æ¨™ -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">å…¬å¸ç¸½æ•¸</div>
                    <div class="value" id="companyCount">-</div>
                    <div class="unit">å®¶</div>
                </div>
                <div class="stat-card">
                    <div class="label">ç¸½æµé‡ (13å€‹æœˆ)</div>
                    <div class="value" id="companyTotalForms">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœ€å¤§æµé‡å…¬å¸</div>
                    <div class="value" id="topCompany" style="font-size: 1.8em;">-</div>
                    <div class="unit">æµé‡</div>
                </div>
                <div class="stat-card">
                    <div class="label">å¹³å‡æ¯å…¬å¸æµé‡</div>
                    <div class="value" id="avgPerCompany">-</div>
                    <div class="unit">ç­†</div>
                </div>
            </div>

            <!-- é—œéµç™¼ç¾ -->
            <div class="chart-container">
                <h2>ğŸ” å…¬å¸åˆ¥åˆ†ææ‘˜è¦</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="companyInsights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <!-- å…¬å¸æµé‡åˆ†å¸ƒ -->
            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ¢ å…¬å¸æµé‡åˆ†å¸ƒ</h2>
                    <div class="chart-wrapper">
                        <canvas id="companyPieChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ“Š å„å…¬å¸æµé‡æ’å</h2>
                    <div class="chart-wrapper">
                        <canvas id="companyBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å…¬å¸é¡åˆ¥åˆ†æ -->
            <div class="chart-container">
                <h2>ğŸ“ˆ å„å…¬å¸è¡¨å–®é¡åˆ¥åˆ†å¸ƒ</h2>
                <div class="chart-wrapper large">
                    <canvas id="companyCategoryChart"></canvas>
                </div>
            </div>

            <!-- ç†±é–€è¡¨å–®ï¼ˆå…¬å¸åˆ¥ï¼‰ -->
            <div class="chart-container">
                <h2>ğŸ”¥ å„å…¬å¸ç†±é–€è¡¨å–® TOP 10</h2>
                <div class="chart-wrapper large">
                    <canvas id="companyTopFormsChart"></canvas>
                </div>
            </div>

            <!-- è©³ç´°å…¬å¸çµ±è¨ˆè¡¨ -->
            <div class="chart-container">
                <h2>ğŸ“‹ è©³ç´°å…¬å¸çµ±è¨ˆ</h2>
                <div class="table-container">
                    <table id="companyDetailTable">
                        <thead>
                            <tr id="companyTableHeader">
                                <th>æ’å</th>
                                <th>é¡åˆ¥</th>
                                <th>è¡¨å–®åç¨±</th>
                            </tr>
                        </thead>
                        <tbody id="companyDetailTableBody">
                            <tr>
                                <td colspan="10">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Signature Tab Content -->
        <div id="signature-tab" class="tab-content">
            <!-- é—œéµæŒ‡æ¨™ -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">ä¸Šæœˆç°½æ ¸ç¸½æ¬¡æ•¸ (2025å¹´11æœˆ)</div>
                    <div class="value" id="lastMonthSignTotal">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">13å€‹æœˆç¸½ç°½æ ¸æ¬¡æ•¸</div>
                    <div class="value" id="totalSigns">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">ç°½æ ¸ä¸»ç®¡äººæ•¸</div>
                    <div class="value" id="managerCount">-</div>
                    <div class="unit">ä½</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœˆå¹³å‡ç°½æ ¸æ¬¡æ•¸</div>
                    <div class="value" id="avgSignMonthly">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
            </div>

            <!-- é—œéµç™¼ç¾ -->
            <div class="chart-container">
                <h2>ğŸ” ç°½æ ¸çµ±è¨ˆæ‘˜è¦</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="signInsights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <!-- ä¸»ç®¡ç°½æ ¸æ’å -->
            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ‘¥ ä¸»ç®¡ç°½æ ¸æ¬¡æ•¸æ’å</h2>
                    <div class="chart-wrapper">
                        <canvas id="managerRankChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ“Š ç°½æ ¸æ¬¡æ•¸åˆ†å¸ƒ</h2>
                    <div class="chart-wrapper">
                        <canvas id="signPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- æœˆåº¦ç°½æ ¸è¶¨å‹¢ -->
            <div class="chart-container">
                <h2>ğŸ“ˆ æœˆåº¦ç°½æ ¸æ¬¡æ•¸è¶¨å‹¢</h2>
                <div class="chart-wrapper large">
                    <canvas id="signTrendChart"></canvas>
                </div>
            </div>

            <!-- å„ä¸»ç®¡ç°½æ ¸è¶¨å‹¢ -->
            <div class="chart-container">
                <h2>ğŸ‘¨â€ğŸ’¼ å„ä¸»ç®¡ç°½æ ¸è¶¨å‹¢å°æ¯”</h2>
                <div class="chart-wrapper large">
                    <canvas id="managerTrendChart"></canvas>
                </div>
            </div>

            <!-- è©³ç´°ç°½æ ¸çµ±è¨ˆ -->
            <div class="chart-container">
                <h2>ğŸ“‹ è©³ç´°ç°½æ ¸çµ±è¨ˆ</h2>
                <div class="table-container">
                    <table id="signDetailTable">
                        <thead>
                            <tr id="signTableHeader">
                                <th>æ’å</th>
                                <th>ä¸»ç®¡å§“å</th>
                            </tr>
                        </thead>
                        <tbody id="signDetailTableBody">
                            <tr>
                                <td colspan="15">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Reject Tab Content -->
        <div id="reject-tab" class="tab-content">
            <!-- é—œéµæŒ‡æ¨™ -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">ä¸Šæœˆè¢«é§å›æ¬¡æ•¸ (2025å¹´11æœˆ)</div>
                    <div class="value" id="lastMonthRejectTotal">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">13å€‹æœˆç¸½è¢«é§å›æ¬¡æ•¸</div>
                    <div class="value" id="totalRejects">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœ‰é§å›è¨˜éŒ„äººæ•¸</div>
                    <div class="value" id="applicantCount">-</div>
                    <div class="unit">äºº</div>
                </div>
                <div class="stat-card">
                    <div class="label">è¢«é§å›è¶…é3æ¬¡</div>
                    <div class="value" id="over3Count">-</div>
                    <div class="unit">äºº</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ” è¢«é§å›çµ±è¨ˆæ‘˜è¦</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="rejectInsights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ‘¥ ç”³è«‹äººè¢«é§å›æ¬¡æ•¸æ’å TOP 15</h2>
                    <div class="chart-wrapper">
                        <canvas id="applicantRankChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ¢ å„å…¬å¸è¢«é§å›æ¬¡æ•¸çµ±è¨ˆ</h2>
                    <div class="chart-wrapper">
                        <canvas id="companyRejectChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“ˆ æœˆåº¦è¢«é§å›æ¬¡æ•¸è¶¨å‹¢</h2>
                <div class="chart-wrapper large">
                    <canvas id="rejectTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>âš ï¸ è¢«é§å›è¶…é3æ¬¡çš„ç”³è«‹äºº</h2>
                <div class="chart-wrapper large">
                    <canvas id="over3Chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“‹ è©³ç´°è¢«é§å›çµ±è¨ˆ</h2>
                <div class="table-container no-scroll">
                    <table id="rejectDetailTable">
                        <thead>
                            <tr id="rejectTableHeader">
                                <th>æ’å</th>
                                <th>å…¬å¸</th>
                                <th>ç”³è«‹äººå§“å</th>
                            </tr>
                        </thead>
                        <tbody id="rejectDetailTableBody">
                            <tr>
                                <td colspan="16">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Manager Reject Tab Content -->
        <div id="manager-reject-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">ä¸Šæœˆä¸»ç®¡é§å›æ¬¡æ•¸ (2025å¹´11æœˆ)</div>
                    <div class="value" id="lastMonthMgrRejectTotal">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">13å€‹æœˆç¸½é§å›æ¬¡æ•¸</div>
                    <div class="value" id="totalMgrRejects">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœ‰é§å›è¨˜éŒ„ä¸»ç®¡æ•¸</div>
                    <div class="value" id="mgrRejectCount">-</div>
                    <div class="unit">ä½</div>
                </div>
                <div class="stat-card">
                    <div class="label">é§å›è¶…é3æ¬¡ä¸»ç®¡</div>
                    <div class="value" id="mgrOver3Count">-</div>
                    <div class="unit">ä½</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ” ä¸»ç®¡é§å›çµ±è¨ˆæ‘˜è¦</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="mgrRejectInsights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡é§å›æ¬¡æ•¸æ’å TOP 15</h2>
                    <div class="chart-wrapper">
                        <canvas id="mgrRejectRankChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ¢ å„å…¬å¸ä¸»ç®¡é§å›æ¬¡æ•¸çµ±è¨ˆ</h2>
                    <div class="chart-wrapper">
                        <canvas id="mgrCompanyRejectChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“ˆ æœˆåº¦ä¸»ç®¡é§å›æ¬¡æ•¸è¶¨å‹¢</h2>
                <div class="chart-wrapper large">
                    <canvas id="mgrRejectTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>âš ï¸ é§å›è¶…é3æ¬¡çš„ä¸»ç®¡</h2>
                <div class="chart-wrapper large">
                    <canvas id="mgrOver3Chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“‹ è©³ç´°ä¸»ç®¡é§å›çµ±è¨ˆ</h2>
                <div class="table-container no-scroll">
                    <table id="mgrRejectDetailTable">
                        <thead>
                            <tr id="mgrRejectTableHeader">
                                <th>æ’å</th>
                                <th>å…¬å¸</th>
                                <th>ä¸»ç®¡å§“å</th>
                            </tr>
                        </thead>
                        <tbody id="mgrRejectDetailTableBody">
                            <tr>
                                <td colspan="16">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Approval Time Tab Content -->
        <div id="approval-time-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">ç¸½ç°½æ ¸è¨˜éŒ„æ•¸</div>
                    <div class="value" id="totalApprovalRecords">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">è¡¨å–®ç¸½æ•¸</div>
                    <div class="value" id="totalApprovalForms">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">æµç¨‹è¶…é10é—œ</div>
                    <div class="value" id="over10FormsCount">-</div>
                    <div class="unit">ç­†</div>
                </div>
                <div class="stat-card">
                    <div class="label">ç°½æ ¸è¶…é3å¤©</div>
                    <div class="value" id="over3DaysCount">-</div>
                    <div class="unit">ç­†</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ” ç°½æ ¸æ™‚é–“çµ±è¨ˆæ‘˜è¦</h2>
                <div class="insight-box">
                    <h3>çµ±è¨ˆæ‘˜è¦</h3>
                    <ul id="approvalTimeInsights">
                        <li>è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>

            <div class="two-column">
                <div class="chart-container">
                    <h2>ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å¹³å‡ç°½æ ¸æ™‚é–“ TOP 15 (æœ€æ…¢)</h2>
                    <div class="chart-wrapper">
                        <canvas id="managerTimeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>ğŸ¢ å„å…¬å¸å¹³å‡ç°½æ ¸æ™‚é–“</h2>
                    <div class="chart-wrapper">
                        <canvas id="companyTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“Š ç°½æ ¸æ™‚é–“åˆ†å¸ƒ</h2>
                <div class="chart-wrapper large">
                    <canvas id="timeDistributionChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ”´ æµç¨‹è¶…é10é—œçš„è¡¨å–®</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è¡¨å–®è™Ÿç¢¼</th>
                                <th>ä¸»æ—¨</th>
                                <th>ç”³è«‹å–®ä½</th>
                                <th>ç”³è«‹äºº</th>
                                <th>æµç¨‹é—œå¡æ•¸</th>
                            </tr>
                        </thead>
                        <tbody id="over10FormsTableBody">
                            <tr>
                                <td colspan="5">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="chart-container">
                <h2>âš ï¸ ç°½æ ¸æ™‚é–“è¶…é3å¤©çš„è¨˜éŒ„</h2>
                <div class="chart-wrapper large">
                    <canvas id="over3DaysChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ“‹ å„è¡¨å–®ç°½æ ¸æ™‚é–“çµ±è¨ˆ</h2>
                <div class="table-container">
                    <table id="formTimeTable">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>è¡¨å–®è™Ÿç¢¼</th>
                                <th>ä¸»æ—¨</th>
                                <th>é—œå¡æ•¸</th>
                                <th>ç¸½æ™‚é–“</th>
                                <th>å¹³å‡æ¯é—œ</th>
                                <th>æœ€é•·é—œå¡</th>
                            </tr>
                        </thead>
                        <tbody id="formTimeTableBody">
                            <tr>
                                <td colspan="7">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2025 è¯è‹“è¡¨å–®çµ±è¨ˆç³»çµ± | æ•¸æ“šæ›´æ–°æ™‚é–“: <span id="updateTime"></span></p>
        </div>
    </div>

    <script>
        // å¾JSONè¼‰å…¥è³‡æ–™

        // ============== å¾ sessionStorage åŠ è¼‰æ•¸æ“š ==============
        let monthlyData, companyData, signatureData, rejectData, managerRejectData, approvalTimeData;

        (function loadDataFromSession() {
            const storedData = sessionStorage.getItem('bpmAnalysisData');
            const fileName = sessionStorage.getItem('uploadedFileName');

            if (!storedData) {
                alert('æ²’æœ‰æ‰¾åˆ°åˆ†ææ•¸æ“šï¼Œè«‹å…ˆä¸Šå‚³Excelæª”æ¡ˆ');
                window.location.href = 'index.html';
                return;
            }

            try {
                const allData = JSON.parse(storedData);

                // è¨­ç½®å…¨å±€è®Šæ•¸
                monthlyData = allData.monthly;
                companyData = allData.company;
                signatureData = allData.signature;
                rejectData = allData.reject;
                managerRejectData = allData.managerReject;
                approvalTimeData = allData.approvalTime;

                // é¡¯ç¤ºæª”æ¡ˆå
                const fileNameElement = document.getElementById('uploadedFileName');
                if (fileNameElement) {
                    fileNameElement.textContent = fileName || 'æœªçŸ¥';
                }

                console.log('âœ“ æ•¸æ“šå·²å¾ sessionStorage åŠ è¼‰');

                // æ•¸æ“šåŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œåˆå§‹åŒ–
                setTimeout(function () {
                    init();
                }, 100);
            } catch (error) {
                console.error('æ•¸æ“šåŠ è¼‰å¤±æ•—:', error);
                alert('æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°ä¸Šå‚³');
                window.location.href = 'index.html';
            }
        })();

        let monthlyCharts = {};
        let companyCharts = {};
        let signatureCharts = {};
        let rejectCharts = {};
        let managerRejectCharts = {};
        let approvalTimeCharts = {};

        // Tabåˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–°å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            // åˆå§‹åŒ–å°æ‡‰çš„åœ–è¡¨ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
            if (tabName === 'monthly' && Object.keys(monthlyCharts).length === 0) {
                initMonthlyTab();
            } else if (tabName === 'company' && Object.keys(companyCharts).length === 0) {
                initCompanyTab();
            } else if (tabName === 'signature' && Object.keys(signatureCharts).length === 0) {
                initSignatureTab();
            } else if (tabName === 'reject' && Object.keys(rejectCharts).length === 0) {
                initRejectTab();
            } else if (tabName === 'manager-reject' && Object.keys(managerRejectCharts).length === 0) {
                initManagerRejectTab();
            } else if (tabName === 'approval-time' && Object.keys(approvalTimeCharts).length === 0) {
                initApprovalTimeTab();
            }
        }

        // ============== æœˆåº¦çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateMonthlyStats() {
            const months = monthlyData.months;
            const data = monthlyData.data;

            const totalForms = data.reduce((sum, item) => sum + item.total, 0);
            const lastMonthIdx = months.length - 1;
            const lastMonthTotal = data.reduce((sum, item) => sum + item.monthly_data[lastMonthIdx], 0);
            const avgMonthly = Math.round(totalForms / months.length);
            const formTypes = data.length;

            const categoryStats = {};
            data.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = {
                        total: 0,
                        forms: [],
                        monthly: Array(months.length).fill(0)
                    };
                }
                categoryStats[item.category].total += item.total;
                categoryStats[item.category].forms.push(item.name);
                item.monthly_data.forEach((val, idx) => {
                    categoryStats[item.category].monthly[idx] += val;
                });
            });

            const topForms = [...data].sort((a, b) => b.total - a.total).slice(0, 10);

            return {
                totalForms,
                lastMonthTotal,
                avgMonthly,
                formTypes,
                categoryStats,
                topForms,
                months,
                data
            };
        }

        function updateMonthlyKeyMetrics(stats) {
            document.getElementById('lastMonthTotal').textContent = stats.lastMonthTotal.toLocaleString();
            document.getElementById('totalForms').textContent = stats.totalForms.toLocaleString();
            document.getElementById('formTypes').textContent = stats.formTypes;
            document.getElementById('avgMonthly').textContent = stats.avgMonthly.toLocaleString();
        }

        function generateMonthlyInsights(stats) {
            const insights = [];

            insights.push(`ä¸Šæœˆ(2025å¹´11æœˆ)EIPé›»å­ç°½æ ¸è¡¨å–®æµé‡ç‚º <strong>${stats.lastMonthTotal.toLocaleString()}</strong> ç­†`);

            const lastMonthCategories = {};
            stats.data.forEach(item => {
                if (!lastMonthCategories[item.category]) {
                    lastMonthCategories[item.category] = 0;
                }
                lastMonthCategories[item.category] += item.monthly_data[stats.months.length - 1];
            });
            const topCategory = Object.entries(lastMonthCategories).sort((a, b) => b[1] - a[1])[0];
            insights.push(`ä¸Šæœˆæµé‡æœ€å¤§çš„é¡åˆ¥ç‚º <strong>${topCategory[0]}</strong>,å…± <strong>${topCategory[1].toLocaleString()}</strong> ç­†`);

            insights.push(`13å€‹æœˆæœŸé–“,æµé‡æœ€å¤§çš„è¡¨å–®ç‚º <strong>${stats.topForms[0].name}</strong>,ç¸½è¨ˆ <strong>${stats.topForms[0].total.toLocaleString()}</strong> ç­†`);

            const categories = Object.entries(stats.categoryStats).sort((a, b) => b[1].total - a[1].total);
            insights.push(`æœ€æ´»èºçš„é¡åˆ¥ç‚º <strong>${categories[0][0]}</strong>,ä½”ç¸½æµé‡çš„ <strong>${((categories[0][1].total / stats.totalForms) * 100).toFixed(1)}%</strong>`);

            const monthlyTotals = Array(stats.months.length).fill(0);
            stats.data.forEach(item => {
                item.monthly_data.forEach((val, idx) => {
                    monthlyTotals[idx] += val;
                });
            });
            const maxMonth = Math.max(...monthlyTotals);
            const minMonth = Math.min(...monthlyTotals);
            const maxMonthIdx = monthlyTotals.indexOf(maxMonth);
            const minMonthIdx = monthlyTotals.indexOf(minMonth);
            insights.push(`æµé‡æœ€é«˜æœˆä»½ç‚º <strong>${stats.months[maxMonthIdx]}</strong> (${maxMonth.toLocaleString()}ç­†),æœ€ä½ç‚º <strong>${stats.months[minMonthIdx]}</strong> (${minMonth.toLocaleString()}ç­†)`);

            document.getElementById('insights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createMonthlyTrendChart(stats) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');

            const monthlyTotals = Array(stats.months.length).fill(0);
            stats.data.forEach(item => {
                item.monthly_data.forEach((val, idx) => {
                    monthlyTotals[idx] += val;
                });
            });

            const labels = stats.months.map(m => {
                const year = m.substring(0, 4);
                const month = m.substring(4, 6);
                return `${year}/${month}`;
            });

            monthlyCharts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¯æœˆè¡¨å–®æµé‡',
                        data: monthlyTotals,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'æµé‡: ' + context.parsed.y.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCategoryPieChart(stats) {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');

            const categories = Object.entries(stats.categoryStats)
                .sort((a, b) => b[1].total - a[1].total);

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(250, 208, 196)',
                'rgb(189, 224, 254)',
                'rgb(162, 210, 255)'
            ];

            monthlyCharts.categoryPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c[0]),
                    datasets: [{
                        data: categories.map(c => c[1].total),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} ç­† (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCategoryBarChart(stats) {
            const ctx = document.getElementById('categoryBarChart').getContext('2d');

            const categories = Object.entries(stats.categoryStats)
                .sort((a, b) => b[1].total - a[1].total);

            monthlyCharts.categoryBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c[0]),
                    datasets: [{
                        label: 'æµé‡ (ç­†)',
                        data: categories.map(c => c[1].total),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'æµé‡: ' + context.parsed.x.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTopFormsChart(stats) {
            const ctx = document.getElementById('topFormsChart').getContext('2d');

            monthlyCharts.topForms = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.topForms.map(f => f.name),
                    datasets: [{
                        label: 'ç¸½æµé‡ (ç­†)',
                        data: stats.topForms.map(f => f.total),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: 'rgb(118, 75, 162)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'ç¸½æµé‡: ' + context.parsed.y.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCategoryTrendChart(stats) {
            const ctx = document.getElementById('categoryTrendChart').getContext('2d');

            const categories = Object.entries(stats.categoryStats)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 5);

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(189, 224, 254)'
            ];

            const labels = stats.months.map(m => {
                const year = m.substring(0, 4);
                const month = m.substring(4, 6);
                return `${year}/${month}`;
            });

            const datasets = categories.map((cat, idx) => ({
                label: cat[0],
                data: cat[1].monthly,
                borderColor: colors[idx],
                backgroundColor: colors[idx].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                tension: 0.4,
                fill: false
            }));

            monthlyCharts.categoryTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyDetailTable(stats) {
            const tbody = document.getElementById('detailTableBody');
            const sortedData = [...stats.data].sort((a, b) => b.total - a.total);

            const rows = sortedData.map((item, idx) => {
                const total = Number.isFinite(item.total) ? item.total : 0;
                const monthCount = stats.months.length || 0;
                const avg = monthCount > 0 ? Math.round(total / monthCount) : 0;
                const lastMonth = item.monthly_data[monthCount - 1] ?? 0;
                const prevMonth = item.monthly_data[monthCount - 2] ?? 0;

                let trend = 'â†’';
                let trendColor = '#666';
                if (lastMonth > prevMonth) {
                    trend = 'â†‘';
                    trendColor = '#28a745';
                } else if (lastMonth < prevMonth) {
                    trend = 'â†“';
                    trendColor = '#dc3545';
                }

                return `
                    <tr>
                        <td><span class="badge">${idx + 1}</span></td>
                        <td>${item.category}</td>
                        <td>${item.name}</td>
                        <td><strong>${total.toLocaleString()}</strong></td>
                        <td>${avg.toLocaleString()}</td>
                        <td>${lastMonth.toLocaleString()}</td>
                        <td style="color: ${trendColor}; font-size: 1.5em;">${trend}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function initMonthlyTab() {
            const stats = calculateMonthlyStats();

            updateMonthlyKeyMetrics(stats);
            generateMonthlyInsights(stats);
            createMonthlyTrendChart(stats);
            createCategoryPieChart(stats);
            createCategoryBarChart(stats);
            createTopFormsChart(stats);
            createCategoryTrendChart(stats);
            createMonthlyDetailTable(stats);
        }

        // ============== å…¬å¸åˆ¥çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateCompanyStats() {
            const companies = companyData.companies;
            const data = companyData.data;
            const months = companyData.months || [];

            // è¨ˆç®—13å€‹æœˆç¸½æµé‡
            const totalForms = data.reduce((sum, item) => sum + item.total, 0);

            // è¨ˆç®—ç•¶æœˆ(æœ€å¾Œä¸€å€‹æœˆ)çš„æµé‡
            const lastMonthIdx = months.length > 0 ? months.length - 1 : 0;
            let currentMonthTotal = 0;

            const companyStats = {};
            const currentMonthCompanyStats = {};

            companies.forEach((company, idx) => {
                companyStats[company] = 0;
                currentMonthCompanyStats[company] = 0;
                data.forEach(item => {
                    companyStats[company] += item.company_data[idx];
                    // å¦‚æœæœ‰æœˆåº¦æ•¸æ“š,è¨ˆç®—ç•¶æœˆæµé‡
                    if (item.monthly_company_data && item.monthly_company_data[lastMonthIdx]) {
                        currentMonthCompanyStats[company] += item.monthly_company_data[lastMonthIdx][idx] || 0;
                    }
                });
            });

            // è¨ˆç®—ç•¶æœˆç¸½æµé‡(å¦‚æœæ²’æœ‰æœˆåº¦æ•¸æ“š,ä½¿ç”¨ç¸½æµé‡é™¤ä»¥æœˆæ•¸ä½œç‚ºä¼°ç®—)
            if (months.length > 0) {
                currentMonthTotal = Object.values(currentMonthCompanyStats).reduce((sum, val) => sum + val, 0);
                // å¦‚æœç•¶æœˆæµé‡ç‚º0,å¯èƒ½æ˜¯æ•¸æ“šçµæ§‹å•é¡Œ,ä½¿ç”¨å¹³å‡å€¼ä¼°ç®—
                if (currentMonthTotal === 0) {
                    currentMonthTotal = Math.round(totalForms / months.length);
                }
            } else {
                currentMonthTotal = totalForms;
            }

            const sortedCompanies = Object.entries(companyStats).sort((a, b) => b[1] - a[1]);
            const topCompany = sortedCompanies[0];
            const avgPerCompany = Math.round(totalForms / companies.length);

            const categoryStats = {};
            data.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = {
                        total: 0,
                        byCompany: Array(companies.length).fill(0)
                    };
                }
                categoryStats[item.category].total += item.total;
                item.company_data.forEach((val, idx) => {
                    categoryStats[item.category].byCompany[idx] += val;
                });
            });

            const topForms = [...data].sort((a, b) => b.total - a.total).slice(0, 10);

            return {
                totalForms,
                currentMonthTotal,
                companyCount: companies.length,
                topCompany,
                avgPerCompany,
                companyStats,
                currentMonthCompanyStats,
                categoryStats,
                topForms,
                companies,
                data,
                months
            };
        }

        function updateCompanyKeyMetrics(stats) {
            document.getElementById('companyCount').textContent = stats.companyCount;
            document.getElementById('companyTotalForms').textContent = stats.totalForms.toLocaleString();
            document.getElementById('topCompany').textContent = stats.topCompany[0];
            document.getElementById('avgPerCompany').textContent = stats.avgPerCompany.toLocaleString();
        }

        function generateCompanyInsights(stats) {
            const insights = [];

            insights.push(`å…±æœ‰ <strong>${stats.companyCount}</strong> å®¶å…¬å¸ä½¿ç”¨è¡¨å–®ç³»çµ±,13å€‹æœˆç¸½æµé‡ç‚º <strong>${stats.totalForms.toLocaleString()}</strong> ç­†`);

            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);
            insights.push(`13å€‹æœˆæœŸé–“æµé‡æœ€å¤§çš„å…¬å¸ç‚º <strong>${sortedCompanies[0][0]}</strong>,å…± <strong>${sortedCompanies[0][1].toLocaleString()}</strong> ç­† (ä½” ${((sortedCompanies[0][1] / stats.totalForms) * 100).toFixed(1)}%)`);
            insights.push(`å‰ä¸‰å¤§å…¬å¸ç‚º: <strong>${sortedCompanies[0][0]}</strong> (${sortedCompanies[0][1].toLocaleString()}ç­†)ã€<strong>${sortedCompanies[1][0]}</strong> (${sortedCompanies[1][1].toLocaleString()}ç­†)ã€<strong>${sortedCompanies[2][0]}</strong> (${sortedCompanies[2][1].toLocaleString()}ç­†)`);

            const categories = Object.entries(stats.categoryStats).sort((a, b) => b[1].total - a[1].total);
            insights.push(`æ‰€æœ‰å…¬å¸ä¸­,æœ€å¸¸ä½¿ç”¨çš„é¡åˆ¥ç‚º <strong>${categories[0][0]}</strong> (${categories[0][1].total.toLocaleString()}ç­†)`);

            insights.push(`å¹³å‡æ¯å®¶å…¬å¸æµé‡ç‚º <strong>${stats.avgPerCompany.toLocaleString()}</strong> ç­† (13å€‹æœˆå¹³å‡)`);

            document.getElementById('companyInsights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createCompanyPieChart(stats) {
            const ctx = document.getElementById('companyPieChart').getContext('2d');

            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(250, 208, 196)',
                'rgb(189, 224, 254)',
                'rgb(162, 210, 255)',
                'rgb(255, 200, 124)',
                'rgb(255, 175, 163)',
                'rgb(206, 147, 216)'
            ];

            companyCharts.companyPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCompanies.map(c => c[0]),
                    datasets: [{
                        data: sortedCompanies.map(c => c[1]),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} ç­† (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCompanyBarChart(stats) {
            const ctx = document.getElementById('companyBarChart').getContext('2d');

            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);

            companyCharts.companyBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCompanies.map(c => c[0]),
                    datasets: [{
                        label: 'æµé‡ (ç­†)',
                        data: sortedCompanies.map(c => c[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'æµé‡: ' + context.parsed.x.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCompanyCategoryChart(stats) {
            const ctx = document.getElementById('companyCategoryChart').getContext('2d');

            const categories = Object.entries(stats.categoryStats).sort((a, b) => b[1].total - a[1].total);

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(250, 208, 196)',
                'rgb(189, 224, 254)',
                'rgb(162, 210, 255)'
            ];

            const datasets = categories.map((cat, idx) => ({
                label: cat[0],
                data: cat[1].byCompany,
                backgroundColor: colors[idx % colors.length],
                borderColor: colors[idx % colors.length],
                borderWidth: 1
            }));

            companyCharts.companyCategory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.companies,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCompanyTopFormsChart(stats) {
            const ctx = document.getElementById('companyTopFormsChart').getContext('2d');

            companyCharts.topForms = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.topForms.map(f => f.name),
                    datasets: [{
                        label: 'ç¸½æµé‡ (ç­†)',
                        data: stats.topForms.map(f => f.total),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: 'rgb(118, 75, 162)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'ç¸½æµé‡: ' + context.parsed.y.toLocaleString() + ' ç­†';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCompanyDetailTable(stats) {
            const header = document.getElementById('companyTableHeader');
            const companyHeaders = stats.companies.map(c => `<th>${c}</th>`).join('');
            header.innerHTML = `
                <th>æ’å</th>
                <th>é¡åˆ¥</th>
                <th>è¡¨å–®åç¨±</th>
                ${companyHeaders}
                <th>ç¸½è¨ˆ</th>
            `;

            const tbody = document.getElementById('companyDetailTableBody');
            const sortedData = [...stats.data].sort((a, b) => b.total - a.total);

            const rows = sortedData.map((item, idx) => {
                const companyCells = item.company_data.map(val => {
                    const value = Number.isFinite(val) ? val : 0;
                    return `<td>${value > 0 ? value.toLocaleString() : '-'}</td>`;
                }).join('');

                return `
                    <tr>
                        <td><span class="badge">${idx + 1}</span></td>
                        <td>${item.category}</td>
                        <td>${item.name}</td>
                        ${companyCells}
                        <td><strong>${(Number.isFinite(item.total) ? item.total : 0).toLocaleString()}</strong></td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function initCompanyTab() {
            const stats = calculateCompanyStats();

            updateCompanyKeyMetrics(stats);
            generateCompanyInsights(stats);
            createCompanyPieChart(stats);
            createCompanyBarChart(stats);
            createCompanyCategoryChart(stats);
            createCompanyTopFormsChart(stats);
            createCompanyDetailTable(stats);
        }

        // ============== ç°½æ ¸æ¬¡æ•¸çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateSignatureStats() {
            const months = signatureData.months;
            const managers = signatureData.managers;

            const totalSigns = managers.reduce((sum, mgr) => sum + mgr.total, 0);
            const lastMonthIdx = months.length - 1;
            const lastMonthSignTotal = managers.reduce((sum, mgr) => sum + mgr.monthly_data[lastMonthIdx], 0);
            const avgSignMonthly = Math.round(totalSigns / months.length);
            const managerCount = managers.length;

            // è¨ˆç®—æ¯æœˆç¸½ç°½æ ¸æ¬¡æ•¸
            const monthlyTotals = Array(months.length).fill(0);
            managers.forEach(mgr => {
                mgr.monthly_data.forEach((val, idx) => {
                    monthlyTotals[idx] += val;
                });
            });

            const sortedManagers = [...managers].sort((a, b) => b.total - a.total);

            // æ‰¾å‡ºä¸Šæœˆç°½æ ¸è¶…é300æ¬¡çš„ä¸»ç®¡
            const over300 = managers.filter(m => m.monthly_data[lastMonthIdx] > 300);

            return {
                totalSigns,
                lastMonthSignTotal,
                avgSignMonthly,
                managerCount,
                sortedManagers,
                monthlyTotals,
                over300,
                months,
                managers
            };
        }

        function updateSignatureKeyMetrics(stats) {
            document.getElementById('lastMonthSignTotal').textContent = stats.lastMonthSignTotal.toLocaleString();
            document.getElementById('totalSigns').textContent = stats.totalSigns.toLocaleString();
            document.getElementById('managerCount').textContent = stats.managerCount;
            document.getElementById('avgSignMonthly').textContent = stats.avgSignMonthly.toLocaleString();
        }

        function generateSignatureInsights(stats) {
            const insights = [];

            insights.push(`ä¸Šæœˆ(2025å¹´11æœˆ)ç¸½ç°½æ ¸æ¬¡æ•¸ç‚º <strong>${stats.lastMonthSignTotal.toLocaleString()}</strong> æ¬¡`);

            insights.push(`13å€‹æœˆæœŸé–“,å…±æœ‰ <strong>${stats.managerCount}</strong> ä½ä¸»ç®¡é€²è¡Œç°½æ ¸,ç¸½ç°½æ ¸æ¬¡æ•¸ç‚º <strong>${stats.totalSigns.toLocaleString()}</strong> æ¬¡`);

            insights.push(`ç°½æ ¸æ¬¡æ•¸æœ€å¤šçš„ä¸»ç®¡ç‚º <strong>${stats.sortedManagers[0].name}</strong>,å…±ç°½æ ¸ <strong>${stats.sortedManagers[0].total.toLocaleString()}</strong> æ¬¡`);

            const avgPerManager = Math.round(stats.totalSigns / stats.managerCount);
            insights.push(`å¹³å‡æ¯ä½ä¸»ç®¡ç°½æ ¸ <strong>${avgPerManager.toLocaleString()}</strong> æ¬¡,æœˆå¹³å‡ <strong>${Math.round(avgPerManager / stats.months.length).toLocaleString()}</strong> æ¬¡`);

            if (stats.over300.length > 0) {
                const names = stats.over300.map(m => `<strong>${m.name}</strong> (${m.monthly_data[stats.months.length - 1]}æ¬¡)`).join('ã€');
                insights.push(`ä¸Šæœˆå–®æœˆç°½æ ¸æ¬¡æ•¸è¶…é300æ¬¡çš„ä¸»ç®¡ç‚º: ${names}`);
            } else {
                insights.push(`ä¸Šæœˆå–®æœˆç°½æ ¸æ¬¡æ•¸è¶…é300æ¬¡çš„ä¸»ç®¡ç‚º: <strong>ç„¡</strong>`);
            }

            const maxMonth = Math.max(...stats.monthlyTotals);
            const minMonth = Math.min(...stats.monthlyTotals);
            const maxMonthIdx = stats.monthlyTotals.indexOf(maxMonth);
            const minMonthIdx = stats.monthlyTotals.indexOf(minMonth);
            insights.push(`ç°½æ ¸æœ€é«˜æœˆä»½ç‚º <strong>${stats.months[maxMonthIdx]}</strong> (${maxMonth.toLocaleString()}æ¬¡),æœ€ä½ç‚º <strong>${stats.months[minMonthIdx]}</strong> (${minMonth.toLocaleString()}æ¬¡)`);

            document.getElementById('signInsights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createManagerRankChart(stats) {
            const ctx = document.getElementById('managerRankChart').getContext('2d');

            signatureCharts.managerRank = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.sortedManagers.map(m => m.name),
                    datasets: [{
                        label: 'ç¸½ç°½æ ¸æ¬¡æ•¸',
                        data: stats.sortedManagers.map(m => m.total),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'ç°½æ ¸æ¬¡æ•¸: ' + context.parsed.x.toLocaleString() + ' æ¬¡';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSignPieChart(stats) {
            const ctx = document.getElementById('signPieChart').getContext('2d');

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(250, 208, 196)',
                'rgb(189, 224, 254)'
            ];

            signatureCharts.signPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: stats.sortedManagers.map(m => m.name),
                    datasets: [{
                        data: stats.sortedManagers.map(m => m.total),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} æ¬¡ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSignTrendChart(stats) {
            const ctx = document.getElementById('signTrendChart').getContext('2d');

            const labels = stats.months.map(m => {
                const year = m.substring(0, 4);
                const month = m.substring(4, 6);
                return `${year}/${month}`;
            });

            signatureCharts.signTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¯æœˆç°½æ ¸æ¬¡æ•¸',
                        data: stats.monthlyTotals,
                        borderColor: 'rgb(118, 75, 162)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'ç°½æ ¸æ¬¡æ•¸: ' + context.parsed.y.toLocaleString() + ' æ¬¡';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createManagerTrendChart(stats) {
            const ctx = document.getElementById('managerTrendChart').getContext('2d');

            const colors = [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(237, 100, 166)',
                'rgb(255, 154, 158)',
                'rgb(250, 208, 196)',
                'rgb(189, 224, 254)'
            ];

            const labels = stats.months.map(m => {
                const year = m.substring(0, 4);
                const month = m.substring(4, 6);
                return `${year}/${month}`;
            });

            const datasets = stats.sortedManagers.map((mgr, idx) => {
                const color = colors[idx % colors.length];
                return {
                    label: mgr.name,
                    data: mgr.monthly_data,
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.4,
                    fill: false
                };
            });

            signatureCharts.managerTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' æ¬¡';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSignatureDetailTable(stats) {
            // æ›´æ–°è¡¨é ­
            const header = document.getElementById('signTableHeader');
            const monthHeaders = stats.months.map(m => {
                const year = m.substring(0, 4);
                const month = m.substring(4, 6);
                return `<th>${year}/${month}</th>`;
            }).join('');
            header.innerHTML = `
                <th>æ’å</th>
                <th>ä¸»ç®¡å§“å</th>
                ${monthHeaders}
                <th>ç¸½è¨ˆ</th>
                <th>æœˆå¹³å‡</th>
            `;

            // æ›´æ–°è¡¨æ ¼å…§å®¹
            const tbody = document.getElementById('signDetailTableBody');

            const rows = stats.sortedManagers.map((mgr, idx) => {
                const monthCells = mgr.monthly_data.map(val =>
                    `<td>${val > 0 ? val.toLocaleString() : '-'}</td>`
                ).join('');

                const avg = Math.round(mgr.total / stats.months.length);

                return `
                    <tr>
                        <td><span class="badge">${idx + 1}</span></td>
                        <td><strong>${mgr.name}</strong></td>
                        ${monthCells}
                        <td><strong>${mgr.total.toLocaleString()}</strong></td>
                        <td>${avg.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function initSignatureTab() {
            const stats = calculateSignatureStats();

            updateSignatureKeyMetrics(stats);
            generateSignatureInsights(stats);
            createManagerRankChart(stats);
            createSignPieChart(stats);
            createSignTrendChart(stats);
            createManagerTrendChart(stats);
            createSignatureDetailTable(stats);
        }



        // ============== ç”³è«‹äººè¢«é§å›çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateRejectStats() {
            const months = rejectData.months;
            const applicants = rejectData.applicants;
            const totalRejects = applicants.reduce((sum, app) => sum + app.total, 0);
            const lastMonthIdx = months.length - 1;
            const lastMonthRejectTotal = applicants.reduce((sum, app) => sum + app.monthly_data[lastMonthIdx], 0);
            const applicantCount = applicants.length;
            const monthlyTotals = Array(months.length).fill(0);
            applicants.forEach(app => {
                app.monthly_data.forEach((val, idx) => {
                    monthlyTotals[idx] += val;
                });
            });
            const sortedApplicants = [...applicants].sort((a, b) => b.total - a.total);
            const over3 = applicants.filter(a => a.total > 3);
            const companyStats = {};
            applicants.forEach(app => {
                if (!companyStats[app.company]) companyStats[app.company] = 0;
                companyStats[app.company] += app.total;
            });
            return { totalRejects, lastMonthRejectTotal, applicantCount, over3Count: over3.length, sortedApplicants, monthlyTotals, over3, companyStats, months, applicants };
        }

        function updateRejectKeyMetrics(stats) {
            document.getElementById('lastMonthRejectTotal').textContent = stats.lastMonthRejectTotal.toLocaleString();
            document.getElementById('totalRejects').textContent = stats.totalRejects.toLocaleString();
            document.getElementById('applicantCount').textContent = stats.applicantCount;
            document.getElementById('over3Count').textContent = stats.over3Count;
        }

        function generateRejectInsights(stats) {
            const insights = [];
            insights.push(`ä¸Šæœˆ(2025å¹´11æœˆ)è¢«é§å›æ¬¡æ•¸ç‚º <strong>${stats.lastMonthRejectTotal.toLocaleString()}</strong> æ¬¡`);
            insights.push(`13å€‹æœˆæœŸé–“,å…±æœ‰ <strong>${stats.applicantCount}</strong> ä½ç”³è«‹äººæ›¾è¢«é§å›,ç¸½é§å›æ¬¡æ•¸ç‚º <strong>${stats.totalRejects.toLocaleString()}</strong> æ¬¡`);
            insights.push(`è¢«é§å›æ¬¡æ•¸æœ€å¤šçš„ç”³è«‹äººç‚º <strong>${stats.sortedApplicants[0].name}</strong> (${stats.sortedApplicants[0].company}),å…±è¢«é§å› <strong>${stats.sortedApplicants[0].total}</strong> æ¬¡`);
            insights.push(`è¢«é§å›è¶…é3æ¬¡çš„ç”³è«‹äººå…±æœ‰ <strong>${stats.over3Count}</strong> ä½`);
            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);
            insights.push(`è¢«é§å›æœ€å¤šçš„å…¬å¸ç‚º <strong>${sortedCompanies[0][0]}</strong>,å…± <strong>${sortedCompanies[0][1]}</strong> æ¬¡`);
            document.getElementById('rejectInsights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createApplicantRankChart(stats) {
            const ctx = document.getElementById('applicantRankChart').getContext('2d');
            const top15 = stats.sortedApplicants.slice(0, 15);
            rejectCharts.applicantRank = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15.map(a => a.name),
                    datasets: [{ label: 'è¢«é§å›æ¬¡æ•¸', data: top15.map(a => a.total), backgroundColor: 'rgba(220, 53, 69, 0.8)', borderColor: 'rgb(220, 53, 69)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }

        function createCompanyRejectChart(stats) {
            const ctx = document.getElementById('companyRejectChart').getContext('2d');
            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);
            rejectCharts.companyReject = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCompanies.map(c => c[0]),
                    datasets: [{ label: 'è¢«é§å›æ¬¡æ•¸', data: sortedCompanies.map(c => c[1]), backgroundColor: 'rgba(255, 154, 158, 0.8)', borderColor: 'rgb(255, 154, 158)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }

        function createRejectTrendChart(stats) {
            const ctx = document.getElementById('rejectTrendChart').getContext('2d');
            const labels = stats.months.map(m => `${m.substring(0, 4)}/${m.substring(4, 6)}`);
            rejectCharts.rejectTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'æ¯æœˆè¢«é§å›æ¬¡æ•¸', data: stats.monthlyTotals, borderColor: 'rgb(220, 53, 69)', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.4, fill: true, pointRadius: 5, pointHoverRadius: 7 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createOver3Chart(stats) {
            const ctx = document.getElementById('over3Chart').getContext('2d');
            const over3Sorted = [...stats.over3].sort((a, b) => b.total - a.total);
            rejectCharts.over3 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: over3Sorted.map(a => a.name + ' (' + a.company + ')'),
                    datasets: [{ label: 'è¢«é§å›æ¬¡æ•¸', data: over3Sorted.map(a => a.total), backgroundColor: over3Sorted.map(a => a.total > 5 ? 'rgba(220, 53, 69, 0.9)' : 'rgba(255, 154, 158, 0.8)'), borderColor: 'rgb(220, 53, 69)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createRejectDetailTable(stats) {
            const header = document.getElementById('rejectTableHeader');
            const monthHeaders = stats.months.map(m => `<th>${m.substring(0, 4)}/${m.substring(4, 6)}</th>`).join('');
            header.innerHTML = `<th>æ’å</th><th>å…¬å¸</th><th>ç”³è«‹äººå§“å</th>${monthHeaders}<th>ç¸½è¨ˆ</th>`;
            const tbody = document.getElementById('rejectDetailTableBody');
            const rows = stats.sortedApplicants.map((app, idx) => {
                const monthCells = app.monthly_data.map(val => {
                    const style = val > 3 ? 'background: #fff3cd; color: #dc3545; font-weight: bold;' : '';
                    return `<td style="${style}"><div class="cell-clamp-2">${val > 0 ? val : '-'}</div></td>`;
                }).join('');
                const totalStyle = app.total > 3 ? 'background: #fff3cd; color: #dc3545; font-weight: bold;' : '';
                return `<tr><td><span class="badge">${idx + 1}</span></td><td><div class="cell-clamp-2">${app.company}</div></td><td><div class="cell-clamp-2">${app.name}</div></td>${monthCells}<td style="${totalStyle}"><strong class="cell-clamp-2">${app.total}</strong></td></tr>`;
            }).join('');
            tbody.innerHTML = rows;
        }

        function initRejectTab() {
            const stats = calculateRejectStats();
            updateRejectKeyMetrics(stats);
            generateRejectInsights(stats);
            createApplicantRankChart(stats);
            createCompanyRejectChart(stats);
            createRejectTrendChart(stats);
            createOver3Chart(stats);
            createRejectDetailTable(stats);
        }

        // ============== ç°½æ ¸ä¸»ç®¡é§å›çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateManagerRejectStats() {
            const months = managerRejectData.months;
            const managers = managerRejectData.managers;
            const totalRejects = managers.reduce((sum, mgr) => sum + mgr.total, 0);
            const lastMonthIdx = months.length - 1;
            const lastMonthRejectTotal = managers.reduce((sum, mgr) => sum + mgr.monthly_data[lastMonthIdx], 0);
            const managerCount = managers.length;
            const monthlyTotals = Array(months.length).fill(0);
            managers.forEach(mgr => {
                mgr.monthly_data.forEach((val, idx) => {
                    monthlyTotals[idx] += val;
                });
            });
            const sortedManagers = [...managers].sort((a, b) => b.total - a.total);
            const over3 = managers.filter(m => m.total > 3);
            const companyStats = {};
            managers.forEach(mgr => {
                if (!companyStats[mgr.company]) companyStats[mgr.company] = 0;
                companyStats[mgr.company] += mgr.total;
            });
            return { totalRejects, lastMonthRejectTotal, managerCount, over3Count: over3.length, sortedManagers, monthlyTotals, over3, companyStats, months, managers };
        }

        function updateManagerRejectKeyMetrics(stats) {
            document.getElementById('lastMonthMgrRejectTotal').textContent = stats.lastMonthRejectTotal.toLocaleString();
            document.getElementById('totalMgrRejects').textContent = stats.totalRejects.toLocaleString();
            document.getElementById('mgrRejectCount').textContent = stats.managerCount;
            document.getElementById('mgrOver3Count').textContent = stats.over3Count;
        }

        function generateManagerRejectInsights(stats) {
            const insights = [];
            insights.push(`ä¸Šæœˆ(2025å¹´11æœˆ)ä¸»ç®¡é§å›æ¬¡æ•¸ç‚º <strong>${stats.lastMonthRejectTotal.toLocaleString()}</strong> æ¬¡`);
            insights.push(`13å€‹æœˆæœŸé–“,å…±æœ‰ <strong>${stats.managerCount}</strong> ä½ä¸»ç®¡æ›¾é§å›ç”³è«‹,ç¸½é§å›æ¬¡æ•¸ç‚º <strong>${stats.totalRejects.toLocaleString()}</strong> æ¬¡`);
            insights.push(`é§å›æ¬¡æ•¸æœ€å¤šçš„ä¸»ç®¡ç‚º <strong>${stats.sortedManagers[0].name}</strong> (${stats.sortedManagers[0].company}),å…±é§å› <strong>${stats.sortedManagers[0].total}</strong> æ¬¡`);
            insights.push(`é§å›è¶…é3æ¬¡çš„ä¸»ç®¡å…±æœ‰ <strong>${stats.over3Count}</strong> ä½`);
            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);
            insights.push(`ä¸»ç®¡é§å›æœ€å¤šçš„å…¬å¸ç‚º <strong>${sortedCompanies[0][0]}</strong>,å…± <strong>${sortedCompanies[0][1]}</strong> æ¬¡`);
            document.getElementById('mgrRejectInsights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createManagerRejectRankChart(stats) {
            const ctx = document.getElementById('mgrRejectRankChart').getContext('2d');
            const top15 = stats.sortedManagers.slice(0, 15);
            managerRejectCharts.mgrRejectRank = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15.map(m => m.name),
                    datasets: [{ label: 'é§å›æ¬¡æ•¸', data: top15.map(m => m.total), backgroundColor: 'rgba(255, 152, 0, 0.8)', borderColor: 'rgb(255, 152, 0)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }

        function createManagerCompanyRejectChart(stats) {
            const ctx = document.getElementById('mgrCompanyRejectChart').getContext('2d');
            const sortedCompanies = Object.entries(stats.companyStats).sort((a, b) => b[1] - a[1]);
            managerRejectCharts.mgrCompanyReject = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCompanies.map(c => c[0]),
                    datasets: [{ label: 'é§å›æ¬¡æ•¸', data: sortedCompanies.map(c => c[1]), backgroundColor: 'rgba(255, 193, 7, 0.8)', borderColor: 'rgb(255, 193, 7)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }

        function createManagerRejectTrendChart(stats) {
            const ctx = document.getElementById('mgrRejectTrendChart').getContext('2d');
            const labels = stats.months.map(m => `${m.substring(0, 4)}/${m.substring(4, 6)}`);
            managerRejectCharts.mgrRejectTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'æ¯æœˆä¸»ç®¡é§å›æ¬¡æ•¸', data: stats.monthlyTotals, borderColor: 'rgb(255, 152, 0)', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.4, fill: true, pointRadius: 5, pointHoverRadius: 7 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createManagerOver3Chart(stats) {
            const ctx = document.getElementById('mgrOver3Chart').getContext('2d');
            const over3Sorted = [...stats.over3].sort((a, b) => b.total - a.total);
            managerRejectCharts.mgrOver3 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: over3Sorted.map(m => m.name + ' (' + m.company + ')'),
                    datasets: [{ label: 'é§å›æ¬¡æ•¸', data: over3Sorted.map(m => m.total), backgroundColor: over3Sorted.map(m => m.total > 10 ? 'rgba(255, 152, 0, 0.9)' : 'rgba(255, 193, 7, 0.8)'), borderColor: 'rgb(255, 152, 0)', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createManagerRejectDetailTable(stats) {
            const header = document.getElementById('mgrRejectTableHeader');
            const monthHeaders = stats.months.map(m => `<th>${m.substring(0, 4)}/${m.substring(4, 6)}</th>`).join('');
            header.innerHTML = `<th>æ’å</th><th>å…¬å¸</th><th>ä¸»ç®¡å§“å</th>${monthHeaders}<th>ç¸½è¨ˆ</th>`;
            const tbody = document.getElementById('mgrRejectDetailTableBody');
            const rows = stats.sortedManagers.map((mgr, idx) => {
                const monthCells = mgr.monthly_data.map(val => {
                    const style = val > 3 ? 'background: #fff3cd; color: #ff9800; font-weight: bold;' : '';
                    return `<td style="${style}"><div class="cell-clamp-2">${val > 0 ? val : '-'}</div></td>`;
                }).join('');
                const totalStyle = mgr.total > 3 ? 'background: #fff3cd; color: #ff9800; font-weight: bold;' : '';
                return `<tr><td><span class="badge">${idx + 1}</span></td><td><div class="cell-clamp-2">${mgr.company}</div></td><td><div class="cell-clamp-2">${mgr.name}</div></td>${monthCells}<td style="${totalStyle}"><strong class="cell-clamp-2">${mgr.total}</strong></td></tr>`;
            }).join('');
            tbody.innerHTML = rows;
        }

        function initManagerRejectTab() {
            const stats = calculateManagerRejectStats();
            updateManagerRejectKeyMetrics(stats);
            generateManagerRejectInsights(stats);
            createManagerRejectRankChart(stats);
            createManagerCompanyRejectChart(stats);
            createManagerRejectTrendChart(stats);
            createManagerOver3Chart(stats);
            createManagerRejectDetailTable(stats);
        }



        // ============== ç°½æ ¸æ™‚é–“çµ±è¨ˆåŠŸèƒ½ ==============
        function calculateApprovalTimeStats() {
            const over10Forms = Array.isArray(approvalTimeData?.over_10_forms) ? approvalTimeData.over_10_forms : [];
            const approvalRecords = Array.isArray(approvalTimeData?.approval_records) ? approvalTimeData.approval_records : [];
            const formStats = approvalTimeData?.form_stats && typeof approvalTimeData.form_stats === 'object' ? approvalTimeData.form_stats : {};
            const managerStats = approvalTimeData?.manager_stats && typeof approvalTimeData.manager_stats === 'object' ? approvalTimeData.manager_stats : {};
            const companyStats = approvalTimeData?.company_stats && typeof approvalTimeData.company_stats === 'object' ? approvalTimeData.company_stats : {};

            const totalRecords = approvalRecords.length;
            const totalFormsCount = Object.keys(formStats).length;
            const over10Count = over10Forms.length;
            const over3DaysCount = approvalRecords.filter(r => r.total_mins > 3 * 24 * 60).length;

            // æ’åºä¸»ç®¡æŒ‰å¹³å‡æ™‚é–“
            const sortedManagers = Object.entries(managerStats)
                .sort((a, b) => b[1].avg_mins - a[1].avg_mins)
                .filter(m => m[0] !== 'ç°½æ ¸ä¸»ç®¡' && m[1].count > 0);

            // æ’åºå…¬å¸æŒ‰å¹³å‡æ™‚é–“
            const sortedCompanies = Object.entries(companyStats)
                .sort((a, b) => b[1].avg_mins - a[1].avg_mins)
                .filter(c => c[0] !== '(Blank)' && c[0] !== 'å…¬å¸');

            // æ’åºè¡¨å–®æŒ‰ç¸½æ™‚é–“
            const sortedForms = Object.entries(formStats)
                .sort((a, b) => b[1].total_time_mins - a[1].total_time_mins);

            return {
                totalRecords,
                totalFormsCount,
                over10Count,
                over3DaysCount,
                over10Forms,
                sortedManagers,
                sortedCompanies,
                sortedForms,
                approvalRecords
            };
        }

        function updateApprovalTimeKeyMetrics(stats) {
            document.getElementById('totalApprovalRecords').textContent = stats.totalRecords.toLocaleString();
            document.getElementById('totalApprovalForms').textContent = stats.totalFormsCount;
            document.getElementById('over10FormsCount').textContent = stats.over10Count;
            document.getElementById('over3DaysCount').textContent = stats.over3DaysCount;
        }

        function generateApprovalTimeInsights(stats) {
            const insights = [];

            insights.push(`å…±æœ‰ <strong>${stats.totalFormsCount}</strong> ç­†è¡¨å–®,<strong>${stats.totalRecords}</strong> ç­†ç°½æ ¸è¨˜éŒ„`);

            if (stats.over10Forms.length > 0) {
                insights.push(`æµç¨‹è¶…é10é—œçš„è¡¨å–®æœ‰ <strong>${stats.over10Count}</strong> ç­†,æœ€å¤šé” <strong>${Math.max(...stats.over10Forms.map(f => f.steps))}</strong> é—œ`);
            } else {
                insights.push(`æµç¨‹è¶…é10é—œçš„è¡¨å–®æœ‰ <strong>0</strong> ç­†,æœ€å¤šé” <strong>0</strong> é—œ`);
            }

            insights.push(`ç°½æ ¸æ™‚é–“è¶…é3å¤©çš„è¨˜éŒ„æœ‰ <strong>${stats.over3DaysCount}</strong> ç­†`);

            if (stats.sortedManagers.length > 0) {
                const slowest = stats.sortedManagers[0];
                insights.push(`å¹³å‡ç°½æ ¸æœ€æ…¢çš„ä¸»ç®¡ç‚º <strong>${slowest[0]}</strong>,å¹³å‡ <strong>${(slowest[1].avg_hours).toFixed(1)}</strong> å°æ™‚`);
            }

            if (stats.sortedCompanies.length > 0) {
                const slowestCompany = stats.sortedCompanies[0];
                insights.push(`å¹³å‡ç°½æ ¸æ™‚é–“æœ€é•·çš„å…¬å¸ç‚º <strong>${slowestCompany[0]}</strong>,å¹³å‡ <strong>${(slowestCompany[1].avg_hours).toFixed(1)}</strong> å°æ™‚`);
            }

            document.getElementById('approvalTimeInsights').innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function createManagerTimeChart(stats) {
            const ctx = document.getElementById('managerTimeChart').getContext('2d');
            const top15 = stats.sortedManagers.slice(0, 15);

            approvalTimeCharts.managerTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15.map(m => m[0]),
                    datasets: [{
                        label: 'å¹³å‡ç°½æ ¸æ™‚é–“ (å°æ™‚)',
                        data: top15.map(m => m[1].avg_hours),
                        backgroundColor: 'rgba(156, 39, 176, 0.8)',
                        borderColor: 'rgb(156, 39, 176)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'å¹³å‡: ' + context.parsed.x.toFixed(1) + ' å°æ™‚';
                                }
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function createCompanyTimeChart(stats) {
            const ctx = document.getElementById('companyTimeChart').getContext('2d');

            approvalTimeCharts.companyTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.sortedCompanies.map(c => c[0]),
                    datasets: [{
                        label: 'å¹³å‡ç°½æ ¸æ™‚é–“ (å°æ™‚)',
                        data: stats.sortedCompanies.map(c => c[1].avg_hours),
                        backgroundColor: 'rgba(103, 58, 183, 0.8)',
                        borderColor: 'rgb(103, 58, 183)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function createTimeDistributionChart(stats) {
            const ctx = document.getElementById('timeDistributionChart').getContext('2d');

            // æ™‚é–“å€é–“çµ±è¨ˆ
            const ranges = {
                '< 1å°æ™‚': 0,
                '1-6å°æ™‚': 0,
                '6-24å°æ™‚': 0,
                '1-3å¤©': 0,
                '> 3å¤©': 0
            };

            stats.approvalRecords.forEach(r => {
                const hours = r.total_mins / 60;
                if (hours < 1) ranges['< 1å°æ™‚']++;
                else if (hours < 6) ranges['1-6å°æ™‚']++;
                else if (hours < 24) ranges['6-24å°æ™‚']++;
                else if (hours < 72) ranges['1-3å¤©']++;
                else ranges['> 3å¤©']++;
            });

            approvalTimeCharts.timeDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'ç°½æ ¸è¨˜éŒ„æ•¸',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(139, 195, 74, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(244, 67, 54, 0.8)'
                        ],
                        borderColor: [
                            'rgb(76, 175, 80)',
                            'rgb(139, 195, 74)',
                            'rgb(255, 193, 7)',
                            'rgb(255, 152, 0)',
                            'rgb(244, 67, 54)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createOver3DaysChart(stats) {
            const ctx = document.getElementById('over3DaysChart').getContext('2d');
            const over3Days = stats.approvalRecords
                .filter(r => r.total_mins > 3 * 24 * 60)
                .sort((a, b) => b.total_mins - a.total_mins)
                .slice(0, 20);

            approvalTimeCharts.over3Days = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: over3Days.map(r => r.manager + ' (' + r.form_no + ')'),
                    datasets: [{
                        label: 'ç°½æ ¸æ™‚é–“ (å¤©)',
                        data: over3Days.map(r => r.total_mins / (24 * 60)),
                        backgroundColor: over3Days.map(r =>
                            r.total_mins > 7 * 24 * 60 ? 'rgba(244, 67, 54, 0.9)' : 'rgba(255, 152, 0, 0.8)'
                        ),
                        borderColor: 'rgb(244, 67, 54)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createOver10FormsTable(stats) {
            const tbody = document.getElementById('over10FormsTableBody');
            const rows = stats.over10Forms.map(form => {
                const stepStyle = form.steps > 12 ? 'background: #fff3cd; color: #d32f2f; font-weight: bold;' : '';
                return `
                    <tr>
                        <td>${form.form_no}</td>
                        <td>${form.subject}</td>
                        <td>${form.dept}</td>
                        <td>${form.applicant}</td>
                        <td style="${stepStyle}"><strong>${form.steps}</strong></td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = rows || '<tr><td colspan="5">ç„¡</td></tr>';
        }

        function createFormTimeTable(stats) {
            const tbody = document.getElementById('formTimeTableBody');
            const rows = stats.sortedForms.map((form, idx) => {
                const [formNo, data] = form;
                const totalHours = data.total_time_mins / 60;
                const avgHours = data.avg_time_mins / 60;
                const maxHours = data.max_step_time / 60;

                return `
                    <tr>
                        <td><span class="badge">${idx + 1}</span></td>
                        <td>${formNo}</td>
                        <td>${data.subject.substring(0, 40)}${data.subject.length > 40 ? '...' : ''}</td>
                        <td>${data.total_steps}</td>
                        <td>${totalHours.toFixed(1)} å°æ™‚</td>
                        <td>${avgHours.toFixed(1)} å°æ™‚</td>
                        <td>${maxHours.toFixed(1)} å°æ™‚</td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = rows;
        }

        function initApprovalTimeTab() {
            const stats = calculateApprovalTimeStats();

            updateApprovalTimeKeyMetrics(stats);
            generateApprovalTimeInsights(stats);
            createManagerTimeChart(stats);
            createCompanyTimeChart(stats);
            createTimeDistributionChart(stats);
            createOver3DaysChart(stats);
            createOver10FormsTable(stats);
            createFormTimeTable(stats);
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('updateTime').textContent = timeStr;
        }

        // åˆå§‹åŒ–
        function init() {
            // åªåˆå§‹åŒ–æœˆåº¦çµ±è¨ˆï¼ˆé è¨­é¡¯ç¤ºçš„åˆ†é ï¼‰
            initMonthlyTab();
            updateTime();
        }

    </script>

</body>

</html>
