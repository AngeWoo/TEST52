<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚æ´²é›†åœ˜è¯è‹“BPMçµ±è¨ˆåˆ†æ - ä¸Šå‚³</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0066B3;
            --primary-dark: #003D6B;
            --primary-light: #3399CC;
            --accent-gold: #C9A961;
            --bg-gradient-start: #F0F4F8;
            --bg-gradient-end: #E8EDF2;
            --card-bg: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #5A6C7D;
            --border-color: #E0E7EE;
            --shadow-sm: 0 2px 8px rgba(0, 102, 179, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 102, 179, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 102, 179, 0.16);
            --shadow-xl: 0 12px 48px rgba(0, 102, 179, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Poppins', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .container {
            max-width: 800px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section h1 {
            color: #FFFFFF;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .logo-section .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .upload-card {
            background: var(--card-bg);
            padding: 45px 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-xl), 0 0 100px rgba(0, 102, 179, 0.3);
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-gold), var(--primary-light));
        }

        .upload-card h2 {
            color: var(--text-primary);
            font-size: 1.8em;
            margin-bottom: 12px;
            text-align: center;
        }

        .upload-card p {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.05em;
        }

        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 16px;
            padding: 45px 32px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(0, 102, 179, 0.02) 0%, rgba(201, 169, 97, 0.02) 100%);
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(0, 102, 179, 0.05) 0%, rgba(201, 169, 97, 0.05) 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(0, 102, 179, 0.08) 0%, rgba(201, 169, 97, 0.08) 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            font-size: 1.2em;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .file-info {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 12px;
            border-left: 5px solid #4CAF50;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-info.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-info-icon {
            font-size: 2em;
        }

        .file-info-text {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2E7D32;
            margin-bottom: 4px;
        }

        .file-size {
            color: #558B2F;
            font-size: 0.9em;
        }

        .analyze-button {
            width: 100%;
            padding: 18px;
            margin-top: 30px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-light));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            display: none;
        }

        .analyze-button.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .analyze-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .analyze-button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(0, 102, 179, 0.1);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1.05em;
        }

        .error-message {
            margin-top: 20px;
            padding: 20px;
            background: #ffebee;
            border-left: 5px solid #f44336;
            border-radius: 12px;
            color: #c62828;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            color: white;
        }

        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .feature-text {
            font-size: 0.95em;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .logo-section h1 {
                font-size: 1.8em;
            }

            .upload-card {
                padding: 32px 26px;
            }

            .upload-area {
                padding: 32px 20px;
            }

            .features {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo-section">
            <h1>ğŸ“Š ç‚æ´²é›†åœ˜è¯è‹“BPMçµ±è¨ˆåˆ†æ</h1>
            <div class="subtitle">æ™ºèƒ½æ•¸æ“šåˆ†æ Â· ä¸€éµç”Ÿæˆå ±è¡¨</div>
        </div>

        <div class="upload-card">
            <h2>ä¸Šå‚³Excelæª”æ¡ˆ</h2>
            <p>æ”¯æ´ .xlsx / .xls æ ¼å¼ï¼Œæª”æ¡ˆå°‡åœ¨ç€è¦½å™¨æœ¬åœ°è™•ç†ï¼Œç¢ºä¿æ•¸æ“šå®‰å…¨</p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <span class="upload-icon">ğŸ“</span>
                <div class="upload-text">é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ‹½è‡³æ­¤</div>
                <div class="upload-hint">è«‹ä¸Šå‚³è¯è‹“BPMçµ±è¨ˆExcelæª”æ¡ˆ</div>
            </div>

            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />

            <div class="file-info" id="fileInfo">
                <span class="file-info-icon">âœ…</span>
                <div class="file-info-text">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
            </div>

            <button class="analyze-button" id="analyzeButton">
                ğŸš€ é–‹å§‹åˆ†æ
            </button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">æ­£åœ¨åˆ†ææ•¸æ“šï¼Œè«‹ç¨å€™...</div>
            </div>

            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="features">
            <div class="feature-item">
                <div class="feature-icon">âš¡</div>
                <div class="feature-text">å³æ™‚è™•ç†<br />ç§’ç´šç”Ÿæˆå ±è¡¨</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ğŸ”’</div>
                <div class="feature-text">æœ¬åœ°è™•ç†<br />æ•¸æ“šå®‰å…¨ä¿å¯†</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ğŸ“Š</div>
                <div class="feature-text">6å¤§ç¶­åº¦<br />å…¨æ–¹ä½åˆ†æ</div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // File input handler
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    selectedFile = file;
                    displayFileInfo(file);
                } else {
                    showError('è«‹ä¸Šå‚³ .xlsx æˆ– .xls æ ¼å¼çš„æª”æ¡ˆ');
                }
            }
        });

        // Analyze button handler
        document.getElementById('analyzeButton').addEventListener('click', processFile);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            selectedFile = file;
            displayFileInfo(file);
        }

        function displayFileInfo(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('analyzeButton').classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function processFile() {
            console.log('ğŸš€ ========================================');
            console.log('ğŸš€ é–‹å§‹è™•ç† Excel æ–‡ä»¶:', selectedFile ? selectedFile.name : 'ç„¡');
            console.log('ğŸš€ ========================================');

            if (!selectedFile) {
                showError('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('analyzeButton').style.display = 'none';
            document.getElementById('errorMessage').classList.remove('show');

            // Read file
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    console.log('ğŸ“– Excel æ–‡ä»¶è®€å–æˆåŠŸ');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    console.log('ğŸ“š å·¥ä½œè¡¨æ•¸é‡:', workbook.SheetNames.length);
                    console.log('ğŸ“š å·¥ä½œè¡¨åç¨±:', workbook.SheetNames);

                    // Verify workbook has required sheets
                    if (workbook.SheetNames.length < 6) {
                        throw new Error('Excelæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€åŒ…å«6å€‹å·¥ä½œè¡¨');
                    }

                    // Process all sheets
                    const allData = {
                        monthly: processMonthlySheet(workbook.Sheets[workbook.SheetNames[0]]),
                        company: processCompanySheet(workbook.Sheets[workbook.SheetNames[1]]),
                        signature: processSignatureSheet(workbook.Sheets[workbook.SheetNames[2]]),
                        reject: processRejectSheet(workbook.Sheets[workbook.SheetNames[3]]),
                        managerReject: processManagerRejectSheet(workbook.Sheets[workbook.SheetNames[4]]),
                        approvalTime: processApprovalTimeSheet(workbook.Sheets[workbook.SheetNames[5]])
                    };

                    // ä¿å­˜èª¿è©¦æ‘˜è¦
                    const debugSummary = {
                        monthlyFormsCount: allData.monthly.data.length,
                        companyCount: allData.company.companies.length,
                        signatureManagersCount: allData.signature.managers.length,
                        rejectApplicantsCount: allData.reject.applicants.length,
                        managerRejectCount: allData.managerReject.managers.length
                    };
                    sessionStorage.setItem('debugSummary', JSON.stringify(debugSummary));

                    // Store data in sessionStorage
                    sessionStorage.setItem('bpmAnalysisData', JSON.stringify(allData));
                    sessionStorage.setItem('uploadedFileName', selectedFile.name);

                    // ========== æ•¸æ“šé©—è­‰ ==========
                    const validationErrors = [];
                    const validationWarnings = [];

                    // é©—è­‰æœˆåº¦çµ±è¨ˆ
                    if (!allData.monthly.months || allData.monthly.months.length === 0) {
                        validationErrors.push('æœˆåº¦çµ±è¨ˆ: æœˆä»½æ•¸æ“šç¼ºå¤±');
                    }
                    if (!allData.monthly.data || allData.monthly.data.length === 0) {
                        validationErrors.push('æœˆåº¦çµ±è¨ˆ: è¡¨å–®æ•¸æ“šç¼ºå¤±');
                    } else if (allData.monthly.data.length < 10) {
                        validationWarnings.push(`æœˆåº¦çµ±è¨ˆ: è¡¨å–®æ•¸é‡è¼ƒå°‘ (${allData.monthly.data.length} å€‹)`);
                    }

                    // é©—è­‰å…¬å¸åˆ¥çµ±è¨ˆ
                    if (!allData.company.companies || allData.company.companies.length === 0) {
                        validationErrors.push('å…¬å¸åˆ¥çµ±è¨ˆ: å…¬å¸æ•¸æ“šç¼ºå¤±');
                    }
                    if (!allData.company.data || allData.company.data.length === 0) {
                        validationErrors.push('å…¬å¸åˆ¥çµ±è¨ˆ: è¡¨å–®æ•¸æ“šç¼ºå¤±');
                    }

                    // é©—è­‰æ•¸æ“šä¸€è‡´æ€§
                    if (allData.monthly.data && allData.company.data) {
                        const monthlyCount = allData.monthly.data.length;
                        const companyCount = allData.company.data.length;
                        const diff = Math.abs(monthlyCount - companyCount);
                        const diffPercent = monthlyCount > 0 ? (diff / monthlyCount) * 100 : 0;
                        if (diffPercent > 30) {
                            validationWarnings.push(`æœˆåº¦çµ±è¨ˆ (${monthlyCount}) èˆ‡å…¬å¸åˆ¥çµ±è¨ˆ (${companyCount}) è¡¨å–®æ•¸é‡å·®ç•°è¼ƒå¤§`);
                        }
                    }

                    console.log('âœ¨ ========================================');
                    console.log('âœ¨ æ•¸æ“šè™•ç†å®Œæˆ! æ‘˜è¦:');
                    console.log('âœ¨ æœˆåº¦çµ±è¨ˆè¡¨å–®æ•¸:', allData.monthly.data.length, 'å€‹');
                    console.log('âœ¨ å…¬å¸æ•¸é‡:', allData.company.companies.length, 'å€‹');
                    console.log('âœ¨ ç°½æ ¸ä¸»ç®¡æ•¸:', allData.signature.managers.length, 'ä½');
                    console.log('âœ¨ ========================================');

                    // é¡¯ç¤ºé©—è­‰çµæœ
                    if (validationErrors.length > 0) {
                        console.error('âŒ æ•¸æ“šé©—è­‰å¤±æ•—:', validationErrors);
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('analyzeButton').style.display = 'block';
                        showError('æ•¸æ“šé©—è­‰å¤±æ•—:\n' + validationErrors.join('\n'));
                        return; // é˜»æ­¢è·³è½‰
                    }

                    if (validationWarnings.length > 0) {
                        console.warn('âš ï¸ æ•¸æ“šé©—è­‰è­¦å‘Š:', validationWarnings);
                        validationWarnings.forEach(w => console.warn('âš ï¸', w));
                    }

                    console.log('âœ¨ 5ç§’å¾Œè·³è½‰åˆ°çµæœé é¢...');
                    console.log('âœ¨ è«‹æˆªåœ–ä¿å­˜ä¸Šæ–¹æ‰€æœ‰æ—¥èªŒ!');
                    console.log('âœ¨ ========================================');

                    // å»¶é²5ç§’å¾Œè·³è½‰,è®“ç”¨æˆ¶æœ‰æ™‚é–“æŸ¥çœ‹æ—¥èªŒ
                    setTimeout(() => {
                        window.location.href = 'results.html';
                    }, 5000);

                } catch (error) {
                    console.error('è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showError('æª”æ¡ˆè™•ç†å¤±æ•—ï¼š' + error.message);
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('analyzeButton').style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
        }

        // Sheet processing functions
        function isMonthToken(value) {
            if (value === null || value === undefined) return false;
            const text = String(value).trim().replace(/\s+/g, '');
            if (!text) return false;
            return (
                /^\d{6}$/.test(text) ||
                /^\d{4}[\/-]\d{1,2}$/.test(text) ||
                /^\d{4}å¹´\d{1,2}æœˆ?$/.test(text)
            );
        }

        function findMonthlyHeaderRow(json) {
            const maxScan = Math.min(json.length, 20);
            for (let i = 0; i < maxScan; i++) {
                const row = json[i];
                if (!row) continue;
                let count = 0;
                for (let j = 0; j < row.length; j++) {
                    if (isMonthToken(row[j])) count++;
                }
                if (count >= 3) return i;
            }
            return 2;
        }

        function extractMonthsFromRow(row) {
            const months = [];
            if (!row) return months;
            let startIdx = -1;
            for (let i = 0; i < row.length; i++) {
                if (isMonthToken(row[i])) {
                    startIdx = i;
                    break;
                }
            }
            if (startIdx === -1) return months;
            for (let i = startIdx; i < row.length; i++) {
                const cell = row[i];
                const text = cell === null || cell === undefined ? '' : String(cell).trim();
                if (!text) break;
                if (String(text).includes('ç¸½è¨ˆ')) break;
                if (!isMonthToken(cell)) break;
                months.push(String(cell));
            }
            return months;
        }

        function findCompanyHeaderRow(json) {
            const maxScan = Math.min(json.length, 20);
            for (let i = 0; i < maxScan; i++) {
                const row = json[i];
                if (!row) continue;
                const hasTotal = row.some(cell => String(cell || '').includes('ç¸½è¨ˆ'));
                if (!hasTotal) continue;
                let nameCount = 0;
                for (let j = 2; j < row.length; j++) {
                    const cell = row[j];
                    const text = cell === null || cell === undefined ? '' : String(cell).trim();
                    if (!text || text === 'ç¸½è¨ˆ') continue;
                    nameCount++;
                }
                if (nameCount >= 2) return i;
            }
            return 2;
        }

        function findDataStartRow(json, headerRowIdx) {
            for (let i = headerRowIdx + 1; i < json.length; i++) {
                const row = json[i];
                if (!row) continue;
                const first = row[0];
                const second = row[1];
                const firstText = first === null || first === undefined ? '' : String(first).trim();
                const secondText = second === null || second === undefined ? '' : String(second).trim();
                if (!firstText) continue;
                // è·³éæ¬„ä½æ¨™é¡Œè¡Œ (åŒ…å«"æµç¨‹é¡åˆ¥"ã€"æµç¨‹åç¨±"ç­‰)
                if (firstText.includes('æµç¨‹é¡åˆ¥') || firstText.includes('é¡åˆ¥') ||
                    secondText.includes('æµç¨‹åç¨±') || secondText.includes('åç¨±')) continue;
                // è·³éåŒ…å«"åˆè¨ˆ"çš„æ¨™é¡Œè¡Œ
                if (firstText.includes('åˆè¨ˆ') || secondText.includes('åˆè¨ˆ')) continue;
                return i;
            }
            return headerRowIdx + 1;
        }

        function processMonthlySheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] ç¸½è¡Œæ•¸:', json.length);
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] å‰5è¡Œæ•¸æ“š:', json.slice(0, 5));

            const headerRowIdx = findMonthlyHeaderRow(json);
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] æ¨™é¡Œè¡Œç´¢å¼•:', headerRowIdx);
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] æ¨™é¡Œè¡Œå…§å®¹:', json[headerRowIdx]);

            const months = extractMonthsFromRow(json[headerRowIdx]);
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] è§£æåˆ°çš„æœˆä»½:', months.length, 'å€‹æœˆä»½:', months);

            const dataStartRow = findDataStartRow(json, headerRowIdx);
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] æ•¸æ“šèµ·å§‹è¡Œ:', dataStartRow);

            const forms = [];
            for (let i = dataStartRow; i < json.length; i++) {
                const row = json[i];
                if (!row || !row[0]) {
                    console.log(`ğŸ“Š [æœˆåº¦çµ±è¨ˆ] ç¬¬ ${i} è¡Œ: ç©ºè¡Œ,è·³é`);
                    continue;
                }

                const firstCol = String(row[0]).trim();
                const secondCol = String(row[1] || '').trim();

                // è·³éé¡åˆ¥åˆè¨ˆè¡Œ (å¦‚"äººäº‹é¡ åˆè¨ˆ"ã€"å…¬æ–‡é¡ åˆè¨ˆ"ç­‰ - ç¬¬äºŒåˆ—ç‚ºç©º)
                if (firstCol.includes('åˆè¨ˆ') && !secondCol) {
                    console.log(`ğŸ“Š [æœˆåº¦çµ±è¨ˆ] ç¬¬ ${i} è¡Œ: é¡åˆ¥åˆè¨ˆè¡Œ,è·³é`);
                    continue;
                }

                // åªæœ‰é‡åˆ°"ç¸½è¨ˆ"æ‰åœæ­¢
                if (firstCol === 'ç¸½è¨ˆ' || firstCol === 'Grand Total') {
                    console.log(`ğŸ“Š [æœˆåº¦çµ±è¨ˆ] ç¬¬ ${i} è¡Œ: é‡åˆ°"ç¸½è¨ˆ",åœæ­¢è§£æ`);
                    console.log(`ğŸ“Š [æœˆåº¦çµ±è¨ˆ] è©²è¡Œå…§å®¹:`, row);
                    break;
                }

                const monthlyData = [];
                let total = 0;
                const firstMonthIdx = row.findIndex(cell => isMonthToken(cell));
                const startIdx = firstMonthIdx > -1 ? firstMonthIdx : 2;

                if (i === dataStartRow || (i > dataStartRow && forms.length < 5)) {
                    console.log(`ğŸ“Š [æœˆåº¦çµ±è¨ˆ] ç¬¬ ${i} è¡Œæ•¸æ“š:`, row);
                }

                for (let j = startIdx; j < startIdx + months.length; j++) {
                    const val = row[j] === '-' || row[j] === null || row[j] === undefined || row[j] === '' ? 0 : Number(row[j]);
                    monthlyData.push(val);
                    total += val;
                }

                forms.push({
                    name: String(row[0]),
                    category: String(row[1] || ''),
                    monthly_data: monthlyData,
                    total: total
                });
            }

            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] è§£æå®Œæˆ! å…±è§£æåˆ°', forms.length, 'å€‹è¡¨å–®');
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] å‰3å€‹è¡¨å–®:', forms.slice(0, 3));
            console.log('ğŸ“Š [æœˆåº¦çµ±è¨ˆ] æœ€å¾Œ3å€‹è¡¨å–®:', forms.slice(-3));

            return { months, data: forms };
        }

        function processCompanySheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] ç¸½è¡Œæ•¸:', json.length);
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] å‰5è¡Œæ•¸æ“š:', json.slice(0, 5));

            const companies = [];

            const headerRowIdx = findCompanyHeaderRow(json);
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] æ¨™é¡Œè¡Œç´¢å¼•:', headerRowIdx);

            const headerRow = json[headerRowIdx] || [];
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] æ¨™é¡Œè¡Œå…§å®¹:', headerRow);

            for (let i = 2; i < headerRow.length; i++) {
                const cell = headerRow[i];
                if (!cell) continue;
                const text = String(cell).trim();
                if (!text || text === 'ç¸½è¨ˆ') break;
                companies.push(text);
            }
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] è§£æåˆ°çš„å…¬å¸:', companies.length, 'å€‹:', companies);

            const data = [];
            const dataStartRow = findDataStartRow(json, headerRowIdx);
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] æ•¸æ“šèµ·å§‹è¡Œ:', dataStartRow);

            for (let i = dataStartRow; i < json.length; i++) {
                const row = json[i];
                if (!row || !row[0]) {
                    console.log(`ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] ç¬¬ ${i} è¡Œ: ç©ºè¡Œ,è·³é`);
                    continue;
                }

                // åªæœ‰ç•¶ç¬¬ä¸€åˆ—å®Œå…¨æ˜¯"åˆè¨ˆ"æˆ–"ç¸½è¨ˆ"æ™‚æ‰åœæ­¢
                const firstCol = String(row[0]).trim();
                const secondCol = String(row[1] || '').trim();
                if (firstCol === 'åˆè¨ˆ' || firstCol === 'ç¸½è¨ˆ' ||
                    firstCol === 'Grand Total' || secondCol === 'åˆè¨ˆ' || secondCol === 'ç¸½è¨ˆ') {
                    console.log(`ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] ç¬¬ ${i} è¡Œ: é‡åˆ°"åˆè¨ˆ",åœæ­¢è§£æ`);
                    console.log(`ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] è©²è¡Œå…§å®¹:`, row);
                    break;
                }

                if (i === dataStartRow || (i > dataStartRow && data.length < 5)) {
                    console.log(`ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] ç¬¬ ${i} è¡Œæ•¸æ“š:`, row);
                }

                const companyData = [];
                let total = 0;
                const startIdx = 2;
                for (let j = startIdx; j < startIdx + companies.length; j++) {
                    const val = row[j] === '-' || row[j] === null || row[j] === undefined || row[j] === '' ? 0 : Number(row[j]);
                    companyData.push(val);
                    total += val;
                }

                data.push({
                    category: String(row[1] || ''),
                    name: String(row[0]),
                    company_data: companyData,
                    total: total
                });
            }

            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] è§£æå®Œæˆ! å…±è§£æåˆ°', data.length, 'å€‹è¡¨å–®');
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] å‰3å€‹è¡¨å–®:', data.slice(0, 3));
            console.log('ğŸ¢ [å…¬å¸åˆ¥çµ±è¨ˆ] æœ€å¾Œ3å€‹è¡¨å–®:', data.slice(-3));

            return { companies, data };
        }

        function processSignatureSheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const months = [];
            for (let i = 2; i < 15; i++) {
                if (json[2] && json[2][i]) months.push(String(json[2][i]));
            }

            const signers = [];
            for (let i = 4; i < json.length; i++) {
                const row = json[i];
                if (!row || !row[1]) break;

                const monthlyData = [];
                let total = 0;
                for (let j = 2; j < 2 + months.length; j++) {
                    const val = row[j] === '-' || !row[j] ? 0 : Number(row[j]);
                    monthlyData.push(val);
                    total += val;
                }

                signers.push({
                    id: String(row[0] || ''),
                    name: String(row[1]),
                    monthly_data: monthlyData,
                    total: total
                });
            }

            return { months, managers: signers };
        }

        function processRejectSheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const months = [];
            for (let i = 2; i < 15; i++) {
                if (json[2] && json[2][i]) months.push(String(json[2][i]));
            }

            const applicants = [];
            let currentCompany = '';

            for (let i = 4; i < json.length; i++) {
                const row = json[i];
                if (!row || String(row[1] || '').includes('åˆè¨ˆ')) continue;

                if (row[0]) currentCompany = String(row[0]);
                if (!row[1]) continue;

                const monthlyData = [];
                let total = 0;
                for (let j = 2; j < 2 + months.length; j++) {
                    const val = row[j] === '-' || !row[j] ? 0 : Number(row[j]);
                    monthlyData.push(val);
                    total += val;
                }

                if (total > 0) {
                    applicants.push({
                        company: currentCompany,
                        name: String(row[1]),
                        monthly_data: monthlyData,
                        total: total
                    });
                }
            }

            return { months, applicants };
        }

        function processManagerRejectSheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const months = [];
            for (let i = 2; i < 15; i++) {
                if (json[2] && json[2][i]) months.push(String(json[2][i]));
            }

            const managers = [];
            let currentCompany = '';

            for (let i = 4; i < json.length; i++) {
                const row = json[i];
                if (!row || String(row[1] || '').includes('åˆè¨ˆ')) continue;

                if (row[0]) currentCompany = String(row[0]);
                if (!row[1]) continue;

                const monthlyData = [];
                let total = 0;
                for (let j = 2; j < 2 + months.length; j++) {
                    const val = row[j] === '-' || !row[j] ? 0 : Number(row[j]);
                    monthlyData.push(val);
                    total += val;
                }

                if (total > 0) {
                    managers.push({
                        company: currentCompany,
                        name: String(row[1]),
                        monthly_data: monthlyData,
                        total: total
                    });
                }
            }

            return { months, managers };
        }

        function processApprovalTimeSheet(sheet) {
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const over10Forms = [];
            for (let i = 3; i < 7; i++) {
                const row = json[i];
                if (row && row[0] && row[4]) {
                    over10Forms.push({
                        form_no: String(row[0]),
                        subject: String(row[1] || ''),
                        dept: String(row[2] || ''),
                        applicant: String(row[3] || ''),
                        steps: Number(row[4])
                    });
                }
            }

            const approvalRecords = [];
            let currentForm = '';
            let currentSubject = '';

            for (let i = 11; i < json.length; i++) {
                const row = json[i];
                if (!row) continue;

                if (row[0]) {
                    currentForm = String(row[0]);
                    currentSubject = String(row[1] || '');
                }

                if (row[2]) {
                    const normalMins = calculateMinutes(row[5], row[6], row[7]);
                    const ccMins = calculateMinutes(row[8], row[9], row[10]);

                    approvalRecords.push({
                        form_no: currentForm,
                        subject: currentSubject,
                        sequence: String(row[2]),
                        company: String(row[3] || ''),
                        manager: String(row[4] || ''),
                        normal_mins: normalMins,
                        cc_mins: ccMins,
                        total_mins: normalMins + ccMins
                    });
                }
            }

            const formStats = {};
            const managerStats = {};
            const companyStats = {};

            approvalRecords.forEach(record => {
                if (record.form_no) {
                    if (!formStats[record.form_no]) {
                        formStats[record.form_no] = {
                            subject: record.subject || '',
                            total_steps: 0,
                            total_time_mins: 0,
                            max_step_time: 0
                        };
                    }
                    const formStat = formStats[record.form_no];
                    formStat.total_steps += 1;
                    formStat.total_time_mins += record.total_mins;
                    if (record.total_mins > formStat.max_step_time) {
                        formStat.max_step_time = record.total_mins;
                    }
                }

                if (record.manager) {
                    if (!managerStats[record.manager]) {
                        managerStats[record.manager] = { total_mins: 0, count: 0 };
                    }
                    managerStats[record.manager].total_mins += record.total_mins;
                    managerStats[record.manager].count += 1;
                }

                if (record.company) {
                    if (!companyStats[record.company]) {
                        companyStats[record.company] = { total_mins: 0, count: 0 };
                    }
                    companyStats[record.company].total_mins += record.total_mins;
                    companyStats[record.company].count += 1;
                }
            });

            Object.values(formStats).forEach(stat => {
                stat.avg_time_mins = stat.total_steps > 0 ? stat.total_time_mins / stat.total_steps : 0;
            });

            Object.values(managerStats).forEach(stat => {
                stat.avg_mins = stat.count > 0 ? stat.total_mins / stat.count : 0;
                stat.avg_hours = stat.avg_mins / 60;
            });

            Object.values(companyStats).forEach(stat => {
                stat.avg_mins = stat.count > 0 ? stat.total_mins / stat.count : 0;
                stat.avg_hours = stat.avg_mins / 60;
            });

            return {
                over_10_forms: over10Forms,
                approval_records: approvalRecords,
                form_stats: formStats,
                manager_stats: managerStats,
                company_stats: companyStats
            };
        }

        function calculateMinutes(days, hours, mins) {
            let total = 0;
            if (days && days !== '-') total += Number(days) * 24 * 60;
            if (hours && hours !== '-') total += Number(hours) * 60;
            if (mins && mins !== '-') total += Number(mins);
            return total;
        }

        // é é¢åŠ è¼‰å®Œæˆæ™‚çš„æ¸¬è©¦æ—¥èªŒ
        console.log('âœ… ========================================');
        console.log('âœ… index.html å·²æˆåŠŸåŠ è¼‰!');
        console.log('âœ… Console æ­£å¸¸é‹ä½œ');
        console.log('âœ… è«‹é¸æ“‡ä¸¦ä¸Šå‚³ Excel æ–‡ä»¶');
        console.log('âœ… ========================================');
    </script>
</body>

</html>